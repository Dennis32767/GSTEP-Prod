-----------------------------------------
npx Hardhat 
------------------------------------------
npx hardhat clean
npx hardhat compile
npx hardhat test          # quick sanity
npx hardhat coverage      # full suite

# Testing  - hardhat



npx hardhat coverage --testfiles "test/Coverage.boost.test.js"
npx hardhat coverage --testfiles "test/cross_chain_governance_l1.more.test.js"
npx hardhat coverage --testfiles "test/cross_chain_governance_l1.test.js"
npx hardhat coverage --testfiles "test/CrossChainGovernanceL1.extra.spec.js"
npx hardhat coverage --testfiles "test/CrossChainGovernanceL1.spec.js"
npx hardhat coverage --testfiles "test/Deployment.test.js"
npx hardhat coverage --testfiles "test/GemStepToken.Extendedtest.js"
npx hardhat coverage --testfiles "test/GemStepToken.recommended.spec.js"
npx hardhat coverage --testfiles "test/GemStepToken.test.js"
npx hardhat coverage --testfiles "test/GemStepToken.upgrade.staking.test.js"
npx hardhat coverage --testfiles "test/gs_emergency_and_l2.extra.test.js"
npx hardhat coverage --testfiles "test/gs_emergency_and_l2.module.test.js"
npx hardhat coverage --testfiles "test/GST.anomaly.spec.js"
npx hardhat coverage --testfiles "test/hardening.test.js"
npx hardhat coverage --testfiles "test/oracleIntegration.spec.js"
npx hardhat coverage --testfiles "test/PostDeployment.test.js"
npx hardhat coverage --testfiles "test/Upgrade.flow.optionA.test.js"
npx hardhat coverage --testfiles "test/Upgrade.flow.test.js"
npx hardhat coverage --testfiles "test/Upgrades.extra.spec.js"
npx hardhat coverage --testfiles "test/withdrawStake.spec.js"
npx hardhat coverage --testfiles "test/Tokenomics.staking.invariants.spec.js"

npx hardhat coverage --testfiles "test/PostDeployment.onchain.test.js"



npx hardhat test test/Coverage.boost.test.js
npx hardhat test test/Deployment.test.js
npx hardhat test test/GemStepToken.test.js
npx hardhat test test/PostDeployment.test.js
npx hardhat test test/GemStepToken.Extendedtest.js
npx hardhat test test/GemStepToken.upgrade.staking.test.js
npx hardhat test test/Upgrade.flow.test.js
npx hardhat test test/Upgrade.flow.optionA.test.js
npx hardhat test test/GEMS.anomaly.spec.js
npx hardhat test test/GemStepToken.recommended.spec.js
npx hardhat test test/GemStepToken.Extendedtest.js
-------------------------------------------------------------------
#Localhost - iniial Run
--------------------------------------------------------------------
# terminal 1
npx hardhat node

# terminal 2 (deploy)
npx hardhat run scripts/deployMockOracleV2.js --network localhost
npx hardhat run scripts/deployGemStepEnv.js --network localhost
npx hardhat run scripts/executeAccept.node.js --network localhost
npx hardhat run scripts/grantRole.toProxyAdmin.js --network localhost
npx hardhat run scripts/checkPostAccept.js --network localhost
npx hardhat run scripts/upgradeRehearsal.optionA.js --network localhost

# Testing  - npx hardhat node
npx hardhat test test/Deployment.test.js --network localhost
npx hardhat test test/GemStepToken.test.js --network localhost
npx hardhat test test/PostDeployment.test.js --network localhost
npx hardhat test test/GemStepToken.Extendedtest.js --network localhost
npx hardhat test test/GemStepToken.upgrade.staking.test.js --network localhost
npx hardhat test test/Upgrade.flow.test.js --network localhost
npx hardhat test test/Upgrade.flow.optionA.test.js --network localhost
npx hardhat test test/GEMS.anomaly.spec.js --network localhost
npx hardhat test test/GemStepToken.recommended.spec.js --network localhost

==================================================================================

#Phase 1 was implmented but not needed: the steps to follow are: 
| Stage | Network          | Action                                                |
| ----- | -----------------| ------------------------------------------------------|
| 1Ô∏è‚É£   | Arbitrum Sepolia | Deploy **GemStepToken (proxy)**                       |
| 2Ô∏è‚É£   | Ethereum Sepolia | Deploy **CrossChainGovernanceL1** using L2 address    |
| 3Ô∏è‚É£   | Arbitrum Sepolia | Call `setL1Governance()` linking the two              |
| 4Ô∏è‚É£   | Ethereum Sepolia | Test retryable tickets (pause/unpause, update params) |
| 5Ô∏è‚É£   | Mainnets         | Repeat once the cross-chain flow is confirmed stable  |
===================================================================================

--------------------------------
#Phase 1 ‚Äî Ethereum Sepolia (L1)
-------------------------------
- Wire-up .Env
-------------------------------
- deployMockOracle
npx hardhat run scripts/deployMockOracleV2.js --network sepolia
Deployer: 0x06811F679D39537679060e82338f4BB508fF6bd5
SEPOLIA_ORACLE_ADDRESS=0x0a30a0dC010c797262cD68AF8BC87E189b6767b5
------------------------------
- deployGemStep
npx hardhat run scripts/deployGemStepEnv.js --network sepolia

------------------------------
Schedule/Execute
- Schedule only (recommended first):
    node scripts/executeAccept.sepolia.js --file .\deployments\sepolia-latest.json --step schedule

- Execute only (after delay has passed):
    node scripts/executeAccept.sepolia.js --file deployments/sepolia-latest.json --step execute

// Signers (2-of-2 owners) via env (any of these names work):
    MS_EOA1_PK / MULTISIG_EOA_1_PK
    MS_EOA2_PK / MULTISIG_EOA_2_PK

- NB
In mini mode, all Timelock.schedule/execute calls must be routed through the multisig; use the printed calldata with your MiniMultisig2of2:
propose(timelock, 0, scheduleCalldata),
other owner approve(id),
execute(id),
wait minDelay,
repeat for executeCalldata.
-------------------------------
- View Contracts on Sepolia Etherscan:
Timelock: https://sepolia.etherscan.io/address/0xC20c56f5a40E865D71b158EAC9294C0798ca6986
MiniMultisig: https://sepolia.etherscan.io/address/0x8BcE653b62215D62C149EF57e090c46B49c4Af14
UpgradeExecutor: https://sepolia.etherscan.io/address/0x85937837A837f91bA194889e27b7A19602058484
GemStep Token: https://sepolia.etherscan.io/address/0x25e6ED5DB86732f541ABa1eB3C0c34F3640118DF

https://sepolia.etherscan.io/address/0x7B69f4651Bf0A79793E87302Dc06CC9836caE623

# Tip: For the first Sepolia run, set Timelock minDelay = 60‚Äì300s. After rehearsal succeeds, update to production delay (e.g., 24‚Äì48h) with Timelock.updateDelay through governance or a scheduled action.
================================================================================


--------------------------------
#Phase 2 ‚Äî Arbitrum Sepolia (L2)
-------------------------------
- Wire-up .Env
-------------------------------
- deployMockOracle
npx hardhat run scripts/deployMockOracleV2.js --network arbitrumSepolia
Deployer:0x873693a93c10D74ef3AB824A548a8c8C2dbd1391 
ARBITRUM_SEPOLIA_ORACLE_ADDRESS=0xd3178ab0DDe67B2239FBd750D600dFaa83792A2D
------------------------------
- deployGemStep
npx hardhat run scripts/deployGemStepEnv.js --network arbitrumSepolia

------------------------------
Schedule/Execute
- Schedule only (recommended first):
    node scripts/executeAccept.arbitrumSepolia.js --file .\deployments\arbitrumSepolia-latest.json --step schedule

- Execute only (after delay has passed):
    node scripts/executeAccept.arbitrumSepolia.js --file deployments/arbitrumSepolia-latest.json --step execute

// Signers (2-of-2 owners) via env (any of these names work):
    MS_EOA1_PK / MULTISIG_EOA_1_PK
    MS_EOA2_PK / MULTISIG_EOA_2_PK

- NB
In mini mode, all Timelock.schedule/execute calls must be routed through the multisig; use the printed calldata with your MiniMultisig2of2:
propose(timelock, 0, scheduleCalldata),
other owner approve(id),
execute(id),
wait minDelay,
repeat for executeCalldata.
-------------------------------
View Contracts on Sepolia.Arbisacn Etherscan:
Timelock: https://sepolia.arbiscan.io/address/0xBc102B6670d7BBcF9bd1D42ceE5163798c1Eb304
MiniMultisig: https://sepolia.arbiscan.io/address/0xcF9B3C8d903bD04d9c5Ff1cb791821AaBe670e76
UpgradeExecutor: https://sepolia.arbiscan.io/address/0x8edbd626eB6b2B5636c8D0C57Ea5Ec483266C0DA
GemStep Token: https://sepolia.arbiscan.io/token/0x00e67e48420D167451c660c8eA1501C2F085182F
-------------------------------

#Phase 3 ‚Äî Test Cross-Chain Functionality (Sepolia + Arbitrum Sepolia)
-------------------------------
- Deploy CrossChainGovernanceL1 on Sepolia (L1)
npx hardhat run scripts/deploy-l1-governance-enhanced.js --network sepolia
Copy the printed governance address ‚Üí put it into .env as L1_GOVERNANCE_ADDR=.

Deployer: 0x06811F679D39537679060e82338f4BB508fF6bd5
Owner   : 0x06811F679D39537679060e82338f4BB508fF6bd5
Inbox   : 0xaAe29B0366299461418F5324a79Afc425BE5ae21
L2Target: 0x00e67e48420D167451c660c8eA1501C2F085182F
RefundL2: 0xb2Ab3889B273604ad7B9FbBA7Bc74667D75f1d4e
Deployed CrossChainGovernanceL1 at: 0xB9b51a080684a472ce6419d140d69D6EF72f29FE

https://sepolia.etherscan.io/address/0xB9b51a080684a472ce6419d140d69D6EF72f29FE

-------------------------------
 
# Wire L1‚ÜîL2 governance
On L2 GemStepToken, call setL1Governance(L1_GOVERNANCE_ADDR) once (admin-only):

- then finish the link to l1:
node scripts/link_l2_set_governor.js --file deployments/arbitrumSepolia-latest.json --step both --wait
or
node scripts/link_l2_set_governor.js --file deployments/arbitrumSepolia-latest.json --step schedule
wait 300sec.........
node scripts/link_l2_set_governor.js --file deployments/arbitrumSepolia-latest.json --step execute

-------------------------------

# Deployer L1 Timelocker for governance
Step 1: Deploy Timelock
npx hardhat run scripts/l1_deploy_timelock_manual.js --network sepolia
L1_TIMELOCK=0x72ae1F5E9cFEF2BE83947a0b5600Eeb745Cf20cd

node scripts/grantRole.toTimelock.viaMini.node.js --file deployments/arbitrumSepolia-latest.json --token 0x00 --timelock 0xB --mini 0xc


Step 2: Transfer Ownership
node scripts/l1_transfer_governance_to_timelock.js

Step 3: Complete Transfer
schedule execute script that respects the 1-hour delay
node scripts/l1_timelock_schedule_transfer.js
node scripts/l1_check_timelock_operations.js (insert correct const operationId)

Step 4: Complete Transfer
schedule execute script that respects the 1-hour delay
node scripts/l1_timelock_execute_transfer.js - (insert const operationId = "0x"; const CORRECT_SALT = "0x")
These can be found via node scripts/find_correct_salt.js - (insert const SCHEDULE_TX_HASH = "0x")
--------------------------------

------------------------------
- Test L1 ‚Üí L2 parameters (from Sepolia)
# sanity
node scripts/verify_params.js

# Emergency parameters Update
node scripts/governance_schedule_update.js 8000 5000000000000000
üìã NEXT STEP (after 1hr delay elapses):
  node scripts/governance_execute_update.js <opId> <salt> 8000 5000000000000000

# Emergency parameters revert to Baseline
node scripts/governance_schedule_update.js 10000 1000000000000000
üìã NEXT STEP (after 1hr delay elapses):
node scripts/governance_execute_update.js <opId2> <salt2> 10000 1000000000000000

-------------------------------

-------------------------------
- Test L1 ‚Üí L2 Contract pause/unpause (from Sepolia)

# Pause L2
node scripts/tl_pause_schedule.js --on  - # schedule PAUSE
node scripts/tl_pause_execute.js <operationId> <salt> on
NB. 10 min delay.........

or
# Unpause L2
node scripts/tl_pause_schedule.js --off  - # schedule UNPAUSE
node scripts/tl_pause_execute.js <operationId> <salt> off
NB. 10 min delay.........

Check on Arbiscan (Arb Sepolia) that the retryable redeemed and the L2 contract paused (your event L2PausedByL1 / Paused).
--------------------------------

-------------------------------

- Test L1 ‚Üí L2 Staking pause/unpause (from Sepolia)

# Staking Pause L2
node scripts/tl_stakingpause_schedule.js --on
node scripts/tl_stakingpause_execute.js <operationId> <salt> --on
NB. 10 min delay.........

or
node scripts/tl_stakingpause_schedule.js --off
node scripts/tl_stakingpause_execute.js <operationId> <salt> --off
NB. 10 min delay.........

check staking Pause
node scripts/check_staking_pause.js
-------------------------------





Configure Source: 

Grant Parameter Admin Role to TL - node scripts/grant_param_admin_to_l2_timelock.viaMini.node.js --file deployments/arbitrumSepolia-latest.json

Confirgure Source - node scripts/configure_sources_via_l2_timelock.js
these are the configurations: const SOURCES = [
  ["basicapp",        false, false], // simple mobile app
  ["mobileapp",       false, false], // alt basic source
  ["googlefit",       false, false],
  ["fitbit",          false, false],
  ["applehealth",     false, false],
  ["corporatetracker",false, false],
  ["medicaldevice",   false, true],  // high-security device, needs attestation
  ["wearablepremium", false, true],
  ["fitnessplatform", true,  false], // batch platform, proof only
  ["enterprise",      true,  false],
  ["premiumtracker",  true,  true],  // max security: proof + attestation
];

node scripts/revoke_param_admin_from_timelock.viaMini.js --file deployments/arbitrumSepolia-latest.json

--------------------------------

Set-up App Backend API SIGNER Role

Relayer caller ‚Üí isTrustedAPI[relayer] = true (the msg.sender)
- node scripts/configure_trusted_api_via_l2_timelock.js


EIP-712 signer ‚Üí has API_SIGNER_ROLE to sign step logs
- node scripts/grant_api_signer_to_project_wallet.js

--------------------------------

- Grant Timelock admin Role
node scripts/grantRole.toTimelock.js --file deployments/arbitrumSepolia-latest.json

- Revoke Timelock admin Role
npx hardhat run --network arbitrumSepolia scripts/revokeRole.fromTimelock.js

-------------------------------

UPGRADE STEPS

npx hardhat run scripts/deploy_new_impl.js --network arbitrumSepolia

$env:NEW_IMPL="0xEDD632F62CbDE11458f73f7C0eF29DDa61864085"
node scripts/tl_executor_schedule_upgradeAndCall.js


$env:NEW_IMPL="0xEDD632F62CbDE11458f73f7C0eF29DDa61864085"
$env:INIT_DATA="0x"
node scripts/tl_executor_execute_upgradeAndCall.js

check upgrade
node scripts/check_proxy_slots.js

-------------------------------------------------------------------------------

npx hardhat run scripts/grantRole.toProxyAdmin.js --network sepolia
npx hardhat run scripts/checkPostAccept.js --network sepolia
Rehearsal: npx hardhat run scripts/upgradeRehearsal.optionA.js --network sepolia
-------------------------------








Next Steps:

Test on a forked Mainnet.

Deploy to Sepolia/Goerli.

Optimize gas and audit.

https://dashboard.alchemy.com/



sample PriceOracle implementation for Staking

How to ‚Äúget one‚Äù in practice
Local/hardhat: Just deploy the MockPriceOracle (your script can do this automatically if PRICE_ORACLE_ADDRESS isn‚Äôt set).

Sepolia/Testnet: Either deploy Mock (good enough) or a Chainlink-based oracle if feeds exist.

Mainnet: Deploy a real oracle (TWAP/Chainlink hybrid), configure its feeds/pools, and point your token to it:


5. Practical Example (Recommended for you)
Safe with 5 signers
Signer 1: Hardware Ledger (held by you as project lead).
Signer 2: Hardware Ledger (held by trusted deputy/colleague).
Signer 3: Hardware Trezor (backup, maybe with company custodian).
Signer 4: Operational EOA (Metamask, restricted use).
Signer 5: Institutional custody or Passkey wallet (last-resort recovery).
Threshold: 3-of-5.
On mainnet and Arbitrum, deploy identical Safes with same signer set.





